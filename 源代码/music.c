#include "config.h"
uint16_t code table[] = {
659 ,
523 ,
783 ,
195 ,
391 ,
329 ,
440 ,
493 ,
466 ,
880 ,
698 ,
587 ,
130 ,
739 ,
622 ,
261 ,
174 ,
415 ,
1046,
97  ,
246 ,
};
uint8_t code tones [] = {0,0,0,1,0,2,3,1,4,5,6,7,8,6,4,0,2,9,10,2,0,1,11,7,1,4,5,6,7,8,6,4,0,2,9,10,2,0,1,11,7,12,2,13,10,14,15,0,16,17,6,1,15,6,1,11,12,2,13,10,14,3,0,18,18,18,3,12,2,13,10,14,15,0,16,17,6,1,15,6,1,11,12,14,11,1,3,3,12,12,2,13,10,14,15,0,16,17,6,1,15,6,1,11,12,2,13,10,14,3,0,18,18,18,3,12,2,13,10,14,15,0,16,17,6,1,15,6,1,11,12,14,11,1,3,3,12,1,1,1,1,11,0,1,6,4,19,1,1,1,1,11,0,3,12,19,1,1,1,1,11,0,1,6,4,19,0,0,0,1,0,2,3,1,4,5,6,7,8,6,4,0,2,9,10,2,0,1,11,7,1,4,5,6,7,8,6,4,0,2,9,10,2,0,1,11,7,0,1,4,3,17,6,10,16,10,6,15,16,7,9,9,9,2,20,10,0,1,3,6,4,15,3,0,1,4,3,17,6,10,16,10,6,15,16,7,10,10,10,0,11,1,3,12,0,1,4,3,17,6,10,16,10,6,15,16,7,9,9,9,2,20,10,0,1,3,6,4,15,3,0,1,4,3,17,6,10,16,10,6,15,16,7,10,10,10,0,11,1,3,12,1,1,1,1,11,0,1,6,4,19,1,1,1,1,11,0,3,12,19,1,1,1,1,11,0,1,6,4,19,0,0,0,1,0,2,3,0,1,4,3,17,6,10,16,10,6,15,16,7,9,9,9,2,20,10,0,1,3,6,4,15,3,0,1,4,3,17,6,10,16,10,6,15,16,7,10,10,10,0,11,1,3,12,0xff};
uint16_t code delays[] ={53,218,218,53,218,548,548,383,383,383,218,218,53,218,53,218,53,218,53,218,218,53,53,383,383,383,383,218,218,53,218,53,218,53,218,53,218,218,53,53,383,218,53,53,53,53,53,53,53,53,53,53,53,53,53,53,218,53,53,53,53,53,218,218,53,218,218,218,53,53,53,53,53,53,53,53,53,53,53,53,53,53,218,383,383,383,53,218,218,218,53,53,53,53,53,53,53,53,53,53,53,53,53,53,218,53,53,53,53,53,218,218,53,218,218,218,53,53,53,53,53,53,53,53,53,53,53,53,53,53,218,383,383,383,53,218,218,53,218,218,53,218,53,218,53,218,218,53,218,218,53,53,53,383,383,218,53,218,218,53,218,53,218,53,218,218,53,218,218,53,218,548,548,383,383,383,218,218,53,218,53,218,53,218,53,218,218,53,53,383,383,383,383,218,218,53,218,53,218,53,218,53,218,218,53,53,383,53,218,53,218,218,53,53,53,53,53,53,218,53,218,53,53,53,53,53,53,53,53,53,53,53,218,53,218,53,218,218,53,53,53,53,53,53,218,53,218,53,53,218,53,218,218,548,53,218,53,218,218,53,53,53,53,53,53,218,53,218,53,53,53,53,53,53,53,53,53,53,53,218,53,218,53,218,218,53,53,53,53,53,53,218,53,218,53,53,218,53,218,218,548,53,218,218,53,218,53,218,53,218,218,53,218,218,53,53,53,383,383,218,53,218,218,53,218,53,218,53,218,218,53,218,218,53,218,548,548,53,218,53,218,218,53,53,53,53,53,53,218,53,218,53,53,53,53,53,53,53,53,53,53,53,218,53,218,53,218,218,53,53,53,53,53,53,218,53,218,53,53,218,53,218,218, 0xff};

void beep(uint16_t freq)
{
	if(settings.volume == 0)return;
	beeping = 50;
	P_SW2 |= 0x80;
	PWMCKS = 0x0f; // PWM 时钟为系统时钟/16
	PWMC = 1500000/freq; //设置 PWM 周期
	PWM0T1= PWMC / (30-settings.volume); //输出低电平
	PWM0T2= 0; //输出高电平
	PWM0CR= 0x80; //使能 PWM0 输出
	P_SW2 &= 0x7f; 
	PWMCR = 0x80;
}

void alert()
{
	beep(3136);
	delay10ms(50);
	beep(2637);
}

uint8_t command_mario(COMMAND_ARGS)
{
	uint16_t i = 0;
	while(keyUp.pressed == 0);
	keyUp.pressed = 0;
	terminal_add_bottom("Started.");
	keep_screen_on = 1;
	while(tones[i]!=0xff)
	{
		beep(table[tones[i]]);	
		delay10ms((delays[i]/10) + 8);
		++i;
		sprintf(oled_tmpstr, "pos:%u", i);
		terminal_modify(0, oled_tmpstr);
		if(keyUp.pressed == 1)
		{
			keyUp.pressed = 0;
			break;
		}
	}
	terminal_add_bottom("End.");
	keep_screen_on = 0;
	return COMMAND_OK;
}

